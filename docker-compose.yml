# زنجیر⛓️ - Docker Compose Configuration
# پیام‌رسان امن و غیرمتمرکز ایرانی‌شده بر پایه Matrix

version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: zanjir-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-dendrite}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-dendrite}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - zanjir-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dendrite}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dendrite Matrix Homeserver
  dendrite:
    image: matrixdotorg/dendrite-monolith:latest
    container_name: zanjir-dendrite
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DOMAIN: ${DOMAIN}
      POSTGRES_USER: ${POSTGRES_USER:-dendrite}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-dendrite}
      REGISTRATION_SHARED_SECRET: ${REGISTRATION_SHARED_SECRET}
    volumes:
      - ./dendrite/dendrite.yaml:/etc/dendrite/dendrite.yaml:ro
      - ./dendrite/matrix_key.pem:/etc/dendrite/matrix_key.pem:ro
      - dendrite-media:/var/dendrite/media
      - dendrite-jetstream:/var/dendrite/jetstream
      - dendrite-search:/var/dendrite/searchindex
    networks:
      - zanjir-network
    command: --config /etc/dendrite/dendrite.yaml

  # Element Web Client
  element:
    image: vectorim/element-web:latest
    container_name: zanjir-element
    restart: unless-stopped
    volumes:
      - ./config/element-config.json:/app/config.json:ro
      - ./config/welcome.html:/app/welcome.html:ro
    networks:
      - zanjir-network

  # Caddy Reverse Proxy with Automatic HTTPS
  caddy:
    image: caddy:2-alpine
    container_name: zanjir-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      # Mount Element Web files for serving
      - element-web:/srv/element:ro
    networks:
      - zanjir-network
    depends_on:
      - dendrite
      - element

  # Utility container to copy Element Web files
  element-copy:
    image: vectorim/element-web:latest
    container_name: zanjir-element-copy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cp -r /app/* /srv/element/
        cp /config/config.json /srv/element/config.json
        cp /config/welcome.html /srv/element/welcome.html
        echo "Element Web files copied successfully"
    volumes:
      - element-web:/srv/element
      - ./config/element-config.json:/config/config.json:ro
      - ./config/welcome.html:/config/welcome.html:ro
    networks:
      - zanjir-network

networks:
  zanjir-network:
    driver: bridge

volumes:
  postgres-data:
    name: zanjir-postgres-data
  dendrite-media:
    name: zanjir-dendrite-media
  dendrite-jetstream:
    name: zanjir-dendrite-jetstream
  dendrite-search:
    name: zanjir-dendrite-search
  caddy-data:
    name: zanjir-caddy-data
  caddy-config:
    name: zanjir-caddy-config
  element-web:
    name: zanjir-element-web
